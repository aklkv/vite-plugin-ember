# Plugin API

## `vitePluginEmber(options?)`

The main Vite plugin. Import and add it to your Vite config.

```ts
import vitePluginEmber from 'vite-plugin-ember';
```

### Options

| Option         | Type                     | Default                                          | Description                                                                                                  |
| -------------- | ------------------------ | ------------------------------------------------ | ------------------------------------------------------------------------------------------------------------ |
| `compilerPath` | `string`                 | `'ember-source/dist/ember-template-compiler.js'` | Path to the Ember template compiler module. Override this only if you need a custom or pre-release compiler. |
| `resolve`      | `Record<string, string>` | `{}`                                             | Custom import resolution map. Keys are bare specifiers, values are resolved paths or package names.          |
| `babelPlugins` | `any[]`                  | `[]`                                             | Additional Babel plugins appended after the built-in template compilation and decorator transforms.          |

### `resolve` option

Use `resolve` to map custom import specifiers to file paths or package names. This is useful for third-party Ember addons, local utility modules, or any import that Vite can't resolve automatically.

```ts
vitePluginEmber({
  resolve: {
    // Map a custom specifier to a local file
    'my-helpers': './src/helpers/index.js',
    // Map to an installed package
    'tracked-built-ins': 'tracked-built-ins',
  },
});
```

With this config, your component code can import from these specifiers:

````md
```gjs live
import { TrackedArray } from 'tracked-built-ins';

// ...
```
````

### `babelPlugins` option

Some Ember addons ship custom Babel plugins that transform specific syntax (e.g., `ember-concurrency`'s async arrow tasks). Add them here:

```ts
vitePluginEmber({
  babelPlugins: ['ember-concurrency/async-arrow-task-transform'],
});
```

These plugins run after the built-in template compilation and decorator transforms.

### What the plugin does

1. **Template compilation** — Preprocesses `<template>` tags via [`content-tag`](https://github.com/embroider-build/content-tag), then compiles them to wire format using [`babel-plugin-ember-template-compilation`](https://github.com/emberjs/babel-plugin-ember-template-compilation).

2. **Decorator transforms** — Converts `@tracked` and other decorators using [`decorator-transforms`](https://github.com/ef4/decorator-transforms).

3. **TypeScript** — Strips type annotations from `.gts` files via `@babel/plugin-transform-typescript`.

4. **Module resolution** — Resolves `@ember/*` and `@glimmer/*` bare specifiers to files inside `ember-source/dist/packages/`.

5. **`@embroider/macros` shim** — Provides runtime implementations for `isDevelopingApp()`, `macroCondition()`, and other compile-time macros that `ember-source`'s ESM modules import.

6. **Virtual module serving** — Handles `virtual:ember-demo-*` modules generated by the markdown fence plugin.

## `emberFence(md, component?)`

A [markdown-it](https://github.com/markdown-it/markdown-it) plugin that transforms code fences into live component mounts.

```ts
import { emberFence } from 'vite-plugin-ember';
```

### Parameters

| Parameter   | Type         | Default         | Description                                    |
| ----------- | ------------ | --------------- | ---------------------------------------------- |
| `md`        | `MarkdownIt` | _(required)_    | The markdown-it instance provided by VitePress |
| `component` | `string`     | `'CodePreview'` | Name of the Vue wrapper component to render    |

> > > > > > > 1fd3f2d (refactor: rename EmberPlayground to CodePreview, use kebab-case files)

### Usage

Register it in your VitePress markdown config:

```ts
export default defineConfig({
  markdown: {
    config(md) {
      emberFence(md);
      // or with a custom component name:
      // emberFence(md, 'MyEmberDemo');
    },
  },
});
```

### Fence syntax

The plugin intercepts fences with `gjs` or `gts` language and a `live` flag:

| Input                   | Output HTML                                                                         |
| ----------------------- | ----------------------------------------------------------------------------------- |
| ` ```gjs live `         | `<CodePreview src="/@id/virtual:ember-demo-HASH.gjs" />`                            |
| ` ```gts live `         | `<CodePreview src="/@id/virtual:ember-demo-HASH.gts" />`                            |
| ` ```gjs live preview ` | `<CodePreview src="..."><div v-pre><pre><code>...</code></pre></div></CodePreview>` |

Each fence body is hashed and stored in a shared registry. The Vite plugin's `load` hook serves the source when the browser requests the virtual module, and the `transform` hook compiles it.

## `CodePreview` (Vue component)

The Vue wrapper component that mounts Ember components into the page.

### Props

| Prop  | Type     | Description                                           |
| ----- | -------- | ----------------------------------------------------- |
| `src` | `string` | URL of the compiled Ember module to import and render |

### Slots

| Slot      | Description                                                                                 |
| --------- | ------------------------------------------------------------------------------------------- |
| `default` | Content displayed below the rendered component (used by `preview` mode to show source code) |

### How it works

1. On mount, it imports the module from `src` using a dynamic `import()`.
2. It imports `renderComponent` from `@ember/renderer`.
3. It calls `renderComponent(Component, { into: element })` to mount the Ember component.
4. On Vue unmount, it calls `cleanup.destroy()` to tear down the Ember component tree.

### Error handling

If the import or render fails, an error banner is displayed inside the component using VitePress theme variables for consistent styling.

## Build pipeline

The compilation flow for each `.gjs` / `.gts` module:

```text
Source (.gjs/.gts)
  │
  ├─ content-tag preprocessor
  │    Converts <template>...</template> into JS function calls
  │
  ├─ Babel transform
  │    ├─ babel-plugin-ember-template-compilation (wire format)
  │    ├─ decorator-transforms (@tracked)
  │    ├─ custom babelPlugins (if configured)
  │    └─ @babel/plugin-transform-typescript (.gts only)
  │
  └─ Compiled ES module
       Ready for browser import
```
